<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Fraud Detection Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="dashboard-container">
            <!-- ===== HEADER ===== -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">üõ°Ô∏è Fraud Detection Dashboard</h1>
                <p class="dashboard-subtitle">Machine Learning-Powered Insurance Claim Analysis</p>
            </div>

            <!-- ===== MAIN GRID ===== -->
            <div class="dashboard-grid">
                <!-- ===== LEFT SIDEBAR: MODEL INFO ===== -->
                <div class="dashboard-sidebar">
                    <!-- Model Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-icon">‚öôÔ∏è</div>
                            <div>
                                <div class="card-header-title">Model Information</div>
                                <div class="card-header-subtitle">RandomForest v2.0</div>
                            </div>
                        </div>
                        <div class="model-info">
                            <div class="info-item">
                                <div class="info-label">Accuracy</div>
                                <div class="info-value">84%</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">F1 Score</div>
                                <div class="info-value">0.704</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Features</div>
                                <div class="info-value">8</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Last Trained</div>
                                <div class="info-value">Mar 2026</div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Importance Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-icon">üìä</div>
                            <div class="card-header-title">Top Features</div>
                        </div>
                        <div class="feature-importance">
                            <div class="feature-bar">
                                <div class="feature-name">Incident Severity</div>
                                <div class="feature-bar-container">
                                    <div class="feature-bar-fill" style="width: 100%;"><span class="feature-value">15.8%</span></div>
                                </div>
                            </div>
                            <div class="feature-bar">
                                <div class="feature-name">Insured Hobbies</div>
                                <div class="feature-bar-container">
                                    <div class="feature-bar-fill" style="width: 51.2%;"><span class="feature-value">8.1%</span></div>
                                </div>
                            </div>
                            <div class="feature-bar">
                                <div class="feature-name">Vehicle Claim</div>
                                <div class="feature-bar-container">
                                    <div class="feature-bar-fill" style="width: 28.3%;"><span class="feature-value">4.5%</span></div>
                                </div>
                            </div>
                            <div class="feature-bar">
                                <div class="feature-name">Insured ZIP</div>
                                <div class="feature-bar-container">
                                    <div class="feature-bar-fill" style="width: 24.8%;"><span class="feature-value">3.9%</span></div>
                                </div>
                            </div>
                            <div class="feature-bar">
                                <div class="feature-name">Total Claim Amount</div>
                                <div class="feature-bar-container">
                                    <div class="feature-bar-fill" style="width: 23.0%;"><span class="feature-value">3.6%</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== CENTER: FORM & PREDICTION ===== -->
                <div class="dashboard-main">
                    <!-- Input Form Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-icon">üìã</div>
                            <div class="card-header-title">Claim Details</div>
                        </div>

                        <form id="predictionForm" method="POST" action="/predict">
                            <!-- ===== POLICY INFORMATION ===== -->
                            <div>
                                <div style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-light);">
                                    <h3 style="font-size: 1rem; color: var(--text-dark); font-weight: 600;">üìÑ Policy Information</h3>
                                </div>
                                <div class="input-section">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Insured ZIP Code
                                            <span class="form-label-unit">(Location)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="insured_zip" 
                                            class="form-input"
                                            placeholder="e.g. 505000"
                                            required
                                        >
                                        <div class="form-hint">Encoded location (430k - 621k)</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Customer Duration
                                            <span class="form-label-unit">(months)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="months_as_customer" 
                                            class="form-input"
                                            placeholder="e.g. 200"
                                            required
                                        >
                                        <div class="form-hint">How long as customer (0 - 479 months)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== CLAIM DETAILS ===== -->
                            <div style="margin-top: var(--spacing-lg);">
                                <div style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-light);">
                                    <h3 style="font-size: 1rem; color: var(--text-dark); font-weight: 600;">üí∞ Claim Details</h3>
                                </div>
                                <div class="input-section">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Total Claim Amount
                                            <span class="form-label-unit">($)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="total_claim_amount" 
                                            class="form-input"
                                            placeholder="e.g. 50000"
                                            required
                                        >
                                        <div class="form-hint">Total amount claimed (100 - 114,920)</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Vehicle Claim Amount
                                            <span class="form-label-unit">($)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="vehicle_claim" 
                                            class="form-input"
                                            placeholder="e.g. 35000"
                                            required
                                        >
                                        <div class="form-hint">Vehicle damage amount (70 - 79,560)</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Property Claim Amount
                                            <span class="form-label-unit">($)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="property_claim" 
                                            class="form-input"
                                            placeholder="e.g. 7500"
                                            required
                                        >
                                        <div class="form-hint">Property damage amount (0 - 23,670)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== INCIDENT DETAILS ===== -->
                            <div style="margin-top: var(--spacing-lg);">
                                <div style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-light);">
                                    <h3 style="font-size: 1rem; color: var(--text-dark); font-weight: 600;">‚ö†Ô∏è Incident Details</h3>
                                </div>
                                <div class="input-section">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Incident Severity
                                            <span class="form-label-unit">(Level)</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            name="incident_severity" 
                                            class="form-input"
                                            placeholder="e.g. 1"
                                            min="0"
                                            max="3"
                                            required
                                        >
                                        <div class="form-hint">0 = Minor, 3 = Severe</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            Incident Date
                                            <span class="form-label-unit">(DD-MM-YYYY)</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            name="incident_date_actual" 
                                            class="form-input"
                                            placeholder="e.g. 15-06-2026"
                                            required
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- ===== CUSTOMER INFORMATION ===== -->
                            <div style="margin-top: var(--spacing-lg);">
                                <div style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-light);">
                                    <h3 style="font-size: 1rem; color: var(--text-dark); font-weight: 600;">üë§ Customer Information</h3>
                                </div>
                                <div class="input-section">
                                    <div class="form-group">
                                        <label class="form-label">
                                            Customer Hobby
                                            <span class="form-label-unit">(Category)</span>
                                        </label>
                                        <select name="insured_hobbies" class="form-input" required>
                                            <option value="">-- Select Hobby --</option>
                                            <option value="0">Base Jumping</option>
                                            <option value="1">Basketball</option>
                                            <option value="2">Board Games</option>
                                            <option value="3">Bungie Jumping</option>
                                            <option value="4">Camping</option>
                                            <option value="5">Chess</option>
                                            <option value="6">Cross-Fit</option>
                                            <option value="7">Dancing</option>
                                            <option value="8">Exercise</option>
                                            <option value="9">Golf</option>
                                            <option value="10">Hiking</option>
                                            <option value="11">Kayaking</option>
                                            <option value="12">Movies</option>
                                            <option value="13">Paintball</option>
                                            <option value="14">Polo</option>
                                            <option value="15">Reading</option>
                                            <option value="16">Skydiving</option>
                                            <option value="17">Sleeping</option>
                                            <option value="18">Video Games</option>
                                            <option value="19">Yachting</option>
                                        </select>
                                        <div class="form-hint">Select insured person's hobby</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== ACTION BUTTONS ===== -->
                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="fillSampleValues()">
                                    ‚ú® Fill Sample Values
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <span id="btnText">üîç Analyze Claim</span>
                                    <span id="spinner" class="spinner hidden"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- ===== PREDICTION RESULT ===== -->
                    <div id="predictionResult" class="hidden">
                        <div class="prediction-panel fade-in">
                            <div class="prediction-badge" id="resultBadge">
                                <span id="resultEmoji">üîç</span> <span id="resultText">Analyzing...</span>
                            </div>
                            <div class="risk-meter">
                                <p class="prediction-text" id="confidenceText">Confidence</p>
                                <div class="risk-gauge">
                                    <div class="risk-gauge-inner">
                                        <div class="risk-score" id="riskScore">0</div>
                                        <div class="risk-unit">/100</div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- ===== INSIGHTS ===== -->
                        <div class="card mt-lg">
                            <div class="card-header">
                                <div class="card-header-icon">üí°</div>
                                <div class="card-header-title">Analysis Insights</div>
                            </div>
                            <div id="insightsContent">Loading insights...</div>
                        </div>
                    </div>
                </div>

                <!-- ===== RIGHT SIDEBAR: FIELD GUIDE ===== -->
                <div class="dashboard-sidebar">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-icon">‚ÑπÔ∏è</div>
                            <div class="card-header-title">Input Guide</div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-light); line-height: 1.6;">
                            <p style="margin-bottom: var(--spacing-md);"><strong>How to Use:</strong></p>
                            <ol style="margin-left: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                                <li>Fill in claim details by category</li>
                                <li>Use dropdown for hobby selection</li>
                                <li>Click "Fill Sample Values" for a demo</li>
                                <li>Click "Analyze Claim" to predict</li>
                            </ol>
                            
                            <p style="margin-bottom: var(--spacing-md); margin-top: var(--spacing-lg);"><strong>Field Ranges:</strong></p>
                            <div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <p><small>üí∞ Claims: $100 - $115k</small></p>
                                <p><small>üìç ZIP: 430k - 621k</small></p>
                                <p><small>‚ö†Ô∏è Severity: 0 - 3</small></p>
                                <p><small>üìÖ Duration: 0 - 479 mo</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SCRIPTS ===== -->
    <script>
        // ===== Sample Data Filling =====
        function fillSampleValues() {
            document.querySelector('[name="insured_zip"]').value = '505000';
            document.querySelector('[name="months_as_customer"]').value = '200';
            document.querySelector('[name="total_claim_amount"]').value = '50000';
            document.querySelector('[name="vehicle_claim"]').value = '35000';
            document.querySelector('[name="property_claim"]').value = '7500';
            document.querySelector('[name="incident_severity"]').value = '1';
            document.querySelector('[name="incident_date_actual"]').value = '15-06-2026';
            document.querySelector('[name="insured_hobbies"]').value = '10';
        }

        // ===== FORM SUBMISSION =====
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('spinner');

            // Show loading
            submitBtn.classList.add('btn-loading');
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            // Collect form data as JSON
            const formData = new FormData(this);
            const jsonData = {
                incident_severity: formData.get('incident_severity'),
                insured_hobbies: formData.get('insured_hobbies'),
                vehicle_claim: formData.get('vehicle_claim'),
                insured_zip: formData.get('insured_zip'),
                total_claim_amount: formData.get('total_claim_amount'),
                property_claim: formData.get('property_claim'),
                incident_date_actual: formData.get('incident_date_actual'),
                months_as_customer: formData.get('months_as_customer'),
            };

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Prediction failed');
                }

                const data = await response.json();
                
                if (data.success) {
                    displayPrediction(data.prediction, data.confidence, data);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Prediction failed: ' + error.message);
            } finally {
                // Hide loading
                submitBtn.classList.remove('btn-loading');
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        });

        // ===== DISPLAY PREDICTION =====
        function displayPrediction(resultText, confidence, responseData) {
            const resultDiv = document.getElementById('predictionResult');
            const resultBadge = document.getElementById('resultBadge');
            const riskScore = document.getElementById('riskScore');
            const progressFill = document.getElementById('progressFill');
            const confidenceText = document.getElementById('confidenceText');
            const insightsContent = document.getElementById('insightsContent');

            // Determine if fraud or not
            const isFraud = resultText === 'Fraud';

            // Update badge
            if (isFraud) {
                resultBadge.className = 'prediction-badge fraud';
                document.getElementById('resultEmoji').textContent = '‚ö†Ô∏è';
            } else {
                resultBadge.className = 'prediction-badge safe';
                document.getElementById('resultEmoji').textContent = '‚úÖ';
            }
            document.getElementById('resultText').textContent = `Prediction: ${resultText}`;

            // Update metrics
            riskScore.textContent = Math.round(confidence);
            progressFill.style.width = confidence + '%';
            confidenceText.textContent = `Confidence: ${Math.round(confidence)}%`;
            
            // Display insights from JSON response
            if (responseData && responseData.insights) {
                let insightsHtml = '<div style="line-height: 1.8;">';
                insightsHtml += `<p style="margin-bottom: var(--spacing-md);"><strong>${responseData.summary}</strong></p>`;
                insightsHtml += `<p style="margin-bottom: var(--spacing-md); color: var(--text-light);">${responseData.interpretation}</p>`;
                insightsHtml += '<div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--radius-md);"><strong style="color: var(--text-dark);">Value Analysis:</strong><ul style="margin: var(--spacing-md) 0 0 var(--spacing-lg); list-style: none;">';
                
                responseData.insights.forEach(insight => {
                    insightsHtml += `<li style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">‚Ä¢ ${insight}</li>`;
                });
                
                insightsHtml += '</ul></div></div>';
                insightsContent.innerHTML = insightsHtml;
            } else {
                insightsContent.innerHTML = `<p>Prediction: <strong>${resultText}</strong> with ${confidence}% confidence</p>`;
            }

            // Show result
            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ===== SELECT STYLING =====
        const selects = document.querySelectorAll('select.form-input');
        selects.forEach(select => {
            select.style.cursor = 'pointer';
            select.style.appearance = 'none';
            select.style.backgroundImage = `url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e")`;
            select.style.backgroundRepeat = 'no-repeat';
            select.style.backgroundPosition = 'right 0.75rem center';
            select.style.backgroundSize = '1.5em';
            select.style.paddingRight = '2.5rem';
        });
    </script>
</body>
</html>
